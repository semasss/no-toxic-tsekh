---
import DownloadButton from '../components/DownloadButton.astro';
import ProgressOverlay from '../components/ProgressOverlay.astro';
import '../styles/global.css';
---

<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–í–∞—à–µ –≤–∏–¥–µ–æ - –Ø –æ—Ç–º–µ–Ω—è—é —Ç–æ–∫—Å–∏–∫</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="alternate icon" href="/favicon.ico">
  <meta name="cloudflare-analytics" content="token=__YOUR_TOKEN__">
</head>
<body class="bg-[#77FF00] min-h-screen flex flex-col items-center justify-center font-sans p-4">
  <div class="relative aspect-[2/3] rounded-[24px] overflow-hidden w-11/12 max-w-md mx-auto">
    <video
      id="main-video"
      autoplay
      muted
      playsinline
      loop
      class="w-full h-full object-cover"
      preload="metadata"
    >
      –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ.
    </video>

    <div class="absolute inset-0 flex items-center justify-center text-center overlay-text">
      <div id="overlay-text" class="text-white text-2xl font-bold px-4 drop-shadow-lg">
        ¬´–î-–≤, –¶–ï–• –∏ ‚Äî –æ—Ç–º–µ–Ω–∏–ª–∏ —Ç–æ–∫—Å–∏–∫. –°–º–æ–ª–µ–Ω—Å–∫. 2025.¬ª
      </div>
    </div>
  </div>

  <DownloadButton />
  <ProgressOverlay />

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const video = document.getElementById('main-video');
      const overlayText = document.getElementById('overlay-text');
      const downloadBtn = document.getElementById('download-btn');

      if (!video || !overlayText) return;

      // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
      const urlParams = new URLSearchParams(window.location.search);
      const gender = urlParams.get('gender');
      const userName = urlParams.get('name');

      // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –≥–ª–∞–≤–Ω—É—é
      if (!gender || !userName) {
        // eslint-disable-next-line no-restricted-globals
        location.href = '/';
        return;
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –æ–≤–µ—Ä–ª–µ—è —Å –∏–º–µ–Ω–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      const text = `¬´–î-–≤, –¶–ï–• –∏ ${userName} –æ—Ç–º–µ–Ω–∏–ª–∏ —Ç–æ–∫—Å–∏–∫. –°–º–æ–ª–µ–Ω—Å–∫. 2025.¬ª`;
      overlayText.textContent = text;

      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–ª–∞
      const videoFile = gender === 'male' ? 'boy.mp4' : 'girl.mp4';
      video.src = `/videos/${videoFile}`;
      
      // eslint-disable-next-line no-console
      console.log(`–ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∏–¥–µ–æ: ${videoFile} –¥–ª—è –ø–æ–ª–∞: ${gender}`);

      // –î–µ–ª–∞–µ–º –∫–Ω–æ–ø–∫—É –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      if (downloadBtn) {
        downloadBtn.disabled = true;
        downloadBtn.classList.add('opacity-50', 'cursor-not-allowed');
      }

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ
      video.addEventListener('loadeddata', () => {
        // eslint-disable-next-line no-console
        console.log('–í–∏–¥–µ–æ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ');
        
        // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
        if (downloadBtn) {
          downloadBtn.disabled = false;
          downloadBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
      });

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ
      video.addEventListener('error', (e) => {
        // eslint-disable-next-line no-console
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ:', e);
        console.error('–ö–æ–¥ –æ—à–∏–±–∫–∏:', video.error?.code);
        console.error('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—à–∏–±–∫–∏:', video.error?.message);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥–ª—É—à–∫—É –≤–º–µ—Å—Ç–æ –≤–∏–¥–µ–æ
        showVideoPlaceholder();
      });

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∫–∏
      video.addEventListener('loadstart', () => {
        // eslint-disable-next-line no-console
        console.log('–ù–∞—á–∞–ª–æ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ');
      });

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∑–∞–≥—Ä—É–∑–∫–∏
      video.addEventListener('progress', () => {
        // eslint-disable-next-line no-console
        console.log('–ü—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ');
      });

      // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –∑–∞–≥–ª—É—à–∫–∏
      function showVideoPlaceholder() {
        const bgColor = gender === 'male' ? '#3B82F6' : '#EC4899'; // –°–∏–Ω–∏–π –¥–ª—è –º—É–∂—á–∏–Ω, —Ä–æ–∑–æ–≤—ã–π –¥–ª—è –∂–µ–Ω—â–∏–Ω
        
        video.style.backgroundColor = bgColor;
        video.style.display = 'flex';
        video.style.alignItems = 'center';
        video.style.justifyContent = 'center';
        video.innerHTML = `
          <div class="text-white text-center p-4">
            <div class="text-4xl mb-4">${gender === 'male' ? 'üë®' : 'üë©'}</div>
            <div class="text-lg mb-2">–í–∏–¥–µ–æ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ</div>
            <div class="text-sm opacity-75">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</div>
          </div>
        `;
        
        // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ –≤–∏–¥–µ–æ
        if (downloadBtn) {
          downloadBtn.disabled = false;
          downloadBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É –≤–∏–¥–µ–æ
      if (!video.canPlayType('video/webm') && !video.canPlayType('video/mp4')) {
        // eslint-disable-next-line no-console
        console.warn('–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç WebM –∏–ª–∏ MP4 –≤–∏–¥–µ–æ');
        showVideoPlaceholder();
      }

      // –¢–∞–π–º–∞—É—Ç –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∫–Ω–æ–ø–∫–∏ –µ—Å–ª–∏ –≤–∏–¥–µ–æ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å
      setTimeout(() => {
        if (downloadBtn && downloadBtn.disabled) {
          // eslint-disable-next-line no-console
          console.log('–ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –ø–æ —Ç–∞–π–º–∞—É—Ç—É');
          downloadBtn.disabled = false;
          downloadBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
      }, 5000); // 5 —Å–µ–∫—É–Ω–¥
    });
  </script>
</body>
</html>
