---
import DownloadButton from '../components/DownloadButton.astro';
import ProgressOverlay from '../components/ProgressOverlay.astro';
import '../styles/global.css';
---

<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–í–∞—à–µ –≤–∏–¥–µ–æ - –Ø –æ—Ç–º–µ–Ω—è—é —Ç–æ–∫—Å–∏–∫</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="alternate icon" href="/favicon.ico">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400&display=swap" rel="stylesheet">
  <script type="importmap">
    {
      "imports": {
        "mp4-muxer": "https://unpkg.com/mp4-muxer@4.0.0/dist/mp4-muxer.js",
        "@ffmpeg/ffmpeg": "https://unpkg.com/@ffmpeg/ffmpeg@0.12.0/dist/esm/ffmpeg.js"
      }
    }
  </script>
  <meta name="cloudflare-analytics" content="token=__YOUR_TOKEN__">
</head>
<body class="bg-[#77FF00] min-h-screen flex flex-col items-center justify-center font-sans p-4">
  <div class="w-11/12 max-w-md mx-auto">
    <div class="relative aspect-[2/3] rounded-[24px] overflow-hidden">
      <video
        id="main-video"
        autoplay
        muted
        playsinline
        loop
        class="w-full h-full object-cover"
        preload="metadata"
      >
        –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ.
      </video>

      <div class="absolute inset-0 flex items-start justify-center text-center overlay-text pt-2.5">
        <div id="overlay-text" class="text-[#77FF00] text-2xl font-normal px-4 drop-shadow-lg leading-[0.85]" style="font-family: 'IBM Plex Mono', monospace;">
          <div class="uppercase">–î-–í, –¶–ï–• –ò ‚Äî</div>
          <div class="uppercase">–û–¢–ú–ï–ù–ò–õ–ò –¢–û–ö–°–ò–ö.</div>
          <div class="uppercase text-center">–°–ú–û–õ–ï–ù–°–ö. 2025</div>
        </div>
      </div>
    </div>

    <DownloadButton />
  </div>
  
  <ProgressOverlay />

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const video = document.getElementById('main-video');
      const overlayText = document.getElementById('overlay-text');
      const downloadBtn = document.getElementById('download-btn');

      if (!video || !overlayText) return;

      // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
      const urlParams = new URLSearchParams(window.location.search);
      const gender = urlParams.get('gender');
      const userName = urlParams.get('name');

      // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –≥–ª–∞–≤–Ω—É—é
      if (!gender || !userName) {
        // eslint-disable-next-line no-restricted-globals
        location.href = '/';
        return;
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –æ–≤–µ—Ä–ª–µ—è —Å –∏–º–µ–Ω–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      overlayText.innerHTML = `
        <div class="uppercase">–î-–í, –¶–ï–• –ò ${userName.toUpperCase()}</div>
        <div class="uppercase">–û–¢–ú–ï–ù–ò–õ–ò –¢–û–ö–°–ò–ö.</div>
        <div class="uppercase text-center">–°–ú–û–õ–ï–ù–°–ö. 2025</div>
      `;
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∏–ª–∏ —á–µ—Ä–µ–∑ JavaScript –¥–ª—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏
      overlayText.style.fontFamily = "'IBM Plex Mono', monospace";
      overlayText.style.lineHeight = '0.85';

      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–ª–∞
      const videoFile = gender === 'male' ? 'boy.mp4' : 'girl.mp4';
      
      // eslint-disable-next-line no-console
      console.log(`–ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∏–¥–µ–æ: ${videoFile} –¥–ª—è –ø–æ–ª–∞: ${gender}`);
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É MP4 –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π
      const canPlayMp4 = video.canPlayType('video/mp4; codecs="avc1.42E01E"');
      const canPlayMp4Basic = video.canPlayType('video/mp4');
      
      // eslint-disable-next-line no-console
      console.log('–ü–æ–¥–¥–µ—Ä–∂–∫–∞ MP4 —Å –∫–æ–¥–µ–∫–æ–º H.264:', canPlayMp4);
      // eslint-disable-next-line no-console
      console.log('–ü–æ–¥–¥–µ—Ä–∂–∫–∞ MP4 –±–∞–∑–æ–≤–∞—è:', canPlayMp4Basic);
      
      if (canPlayMp4Basic === '' && canPlayMp4 === '') {
        // eslint-disable-next-line no-console
        console.warn('–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç MP4 –≤–∏–¥–µ–æ');
        showVideoPlaceholder();
        return;
      }
      
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫ –≤–∏–¥–µ–æ
      video.src = `/videos/${videoFile}`;
      
      // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
      video.load();

      // –î–µ–ª–∞–µ–º –∫–Ω–æ–ø–∫—É –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      if (downloadBtn) {
        downloadBtn.disabled = true;
        downloadBtn.classList.add('opacity-50', 'cursor-not-allowed');
      }

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ
      video.addEventListener('loadeddata', () => {
        // eslint-disable-next-line no-console
        console.log('–í–∏–¥–µ–æ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ');
        
        // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
        if (downloadBtn) {
          downloadBtn.disabled = false;
          downloadBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
      });

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ
      video.addEventListener('error', (e) => {
        // eslint-disable-next-line no-console
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ:', e);
        console.error('–ö–æ–¥ –æ—à–∏–±–∫–∏:', video.error?.code);
        console.error('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—à–∏–±–∫–∏:', video.error?.message);
        
        // –î–µ—Ç–∞–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –æ—à–∏–±–∫–∏
        const errorCode = video.error?.code;
        let errorDescription = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
        
        switch (errorCode) {
          case 1:
            errorDescription = 'MEDIA_ERR_ABORTED: –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ—Ä–≤–∞–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º';
            break;
          case 2:
            errorDescription = 'MEDIA_ERR_NETWORK: –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ';
            break;
          case 3:
            errorDescription = 'MEDIA_ERR_DECODE: –û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è –≤–∏–¥–µ–æ';
            break;
          case 4:
            errorDescription = 'MEDIA_ERR_SRC_NOT_SUPPORTED: –ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç';
            break;
        }
        
        // eslint-disable-next-line no-console
        console.error('–û–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏:', errorDescription);
        
        // –ü—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± –∑–∞–≥—Ä—É–∑–∫–∏
        if (errorCode === 4) {
          // eslint-disable-next-line no-console
          console.log('–ü—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É —á–µ—Ä–µ–∑ Blob URL...');
          tryAlternativeVideoLoad(videoFile);
        } else {
          showVideoPlaceholder();
        }
      });

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∫–∏
      video.addEventListener('loadstart', () => {
        // eslint-disable-next-line no-console
        console.log('–ù–∞—á–∞–ª–æ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ');
      });

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∑–∞–≥—Ä—É–∑–∫–∏
      video.addEventListener('progress', () => {
        // eslint-disable-next-line no-console
        console.log('–ü—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ');
      });

      // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ —á–µ—Ä–µ–∑ fetch
      async function tryAlternativeVideoLoad(videoFile) {
        try {
          // eslint-disable-next-line no-console
          console.log('–ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∏–¥–µ–æ —á–µ—Ä–µ–∑ fetch...');
          
          const response = await fetch(`/videos/${videoFile}`);
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          
          const blob = await response.blob();
          const videoUrl = URL.createObjectURL(blob);
          
          // eslint-disable-next-line no-console
          console.log('–í–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –∫–∞–∫ Blob, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º URL:', videoUrl);
          
          // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Blob URL
          video.src = videoUrl;
          video.load();
          
          // –û—á–∏—â–∞–µ–º URL –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
          video.addEventListener('loadeddata', () => {
            URL.revokeObjectURL(videoUrl);
          }, { once: true });
          
        } catch (error) {
          // eslint-disable-next-line no-console
          console.error('–û—à–∏–±–∫–∞ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏:', error);
          showVideoPlaceholder();
        }
      }

      // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –∑–∞–≥–ª—É—à–∫–∏
      function showVideoPlaceholder() {
        const bgColor = gender === 'male' ? '#3B82F6' : '#EC4899'; // –°–∏–Ω–∏–π –¥–ª—è –º—É–∂—á–∏–Ω, —Ä–æ–∑–æ–≤—ã–π –¥–ª—è –∂–µ–Ω—â–∏–Ω
        
        video.style.backgroundColor = bgColor;
        video.style.display = 'flex';
        video.style.alignItems = 'center';
        video.style.justifyContent = 'center';
        video.innerHTML = `
          <div class="text-white text-center p-4">
            <div class="text-4xl mb-4">${gender === 'male' ? 'üë®' : 'üë©'}</div>
            <div class="text-lg mb-2">–í–∏–¥–µ–æ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ</div>
            <div class="text-sm opacity-75">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</div>
          </div>
        `;
        
        // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ –≤–∏–¥–µ–æ
        if (downloadBtn) {
          downloadBtn.disabled = false;
          downloadBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É –≤–∏–¥–µ–æ
      if (!video.canPlayType('video/webm') && !video.canPlayType('video/mp4')) {
        // eslint-disable-next-line no-console
        console.warn('–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç WebM –∏–ª–∏ MP4 –≤–∏–¥–µ–æ');
        showVideoPlaceholder();
      }

      // –¢–∞–π–º–∞—É—Ç –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∫–Ω–æ–ø–∫–∏ –µ—Å–ª–∏ –≤–∏–¥–µ–æ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å
      setTimeout(() => {
        if (downloadBtn && downloadBtn.disabled) {
          // eslint-disable-next-line no-console
          console.log('–ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –ø–æ —Ç–∞–π–º–∞—É—Ç—É');
          downloadBtn.disabled = false;
          downloadBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
      }, 5000); // 5 —Å–µ–∫—É–Ω–¥
    });
  </script>
</body>
</html>
